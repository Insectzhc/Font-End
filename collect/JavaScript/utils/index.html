<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>测试</title>
	</head>
	<body>
		<div class="drag" style="position: absolute;transform: translate(10px,10px);background: rgba(0,0,0,.5);width:100px;height: 100px;"></div>
		<script src="util.js"></script>
		<script>
			;(function(){
				
				function Drag(selector){
					this.elem = typeof selector === 'Object' ? selector : document.querySelector(selector);
					this.startX = 0;
					this.startY = 0;
					this.sourceX = 0;
					this.sourceY = 0;
					this.init()
				}
				
				Drag.prototype = {
					constructor: Drag,
					init: function(){
						this.bindEvent()
					},
					getTargetPos: function (elem) {
					    var pos = {x: 0, y: 0};
					    var transform = getTransform();
					    if(transform) {
					        var transformValue = getStyle(elem, transform);
					        if(transformValue == 'none') {
					            elem.style[transform] = 'translate(0, 0)';
					            return pos;
					        } else {
					            var temp = transformValue.match(/-?\d+/g);
					            return pos = {
					                x: parseInt(temp[4].trim()),
					                y: parseInt(temp[5].trim())
					            }
					        }
					    } else {
					        if(getStyle(elem, 'position') == 'static') {
					            elem.style.position = 'relative';
					            return pos;
					        } else {
					            var x = parseInt(getStyle(elem, 'left') ? getStyle(elem, 'left') : 0);
					            var y = parseInt(getStyle(elem, 'top') ? getStyle(elem, 'top') : 0);
					            return pos = {
					                x: x,
					                y: y
					            }
					        }
					    }
					},
					// pos = { x: 200, y: 100 }
					setTargetPos: function(elem, pos) {
					    var transform = getTransform();
					    if(transform) {
					        elem.style[transform] = 'translate('+ pos.x +'px, '+ pos.y +'px)';
					    } else {
					        elem.style.left = pos.x + 'px';
					        elem.style.top = pos.y + 'px';
					    }
					    return elem;
					},
					bindEvent: function(){
						var self = this;
						if('ontouchstart' in document){
							this.elem.addEventListener('touchstart', start, false)
						}else{
							this.elem.addEventListener('mousedown', start, false)
						}
						
						//开始拖动
						function start(event){
							self.startX = event.pageX || event.touches[0].pageX;
							self.startY = event.pageY || event.touches[0].pageY;
							var pos = self.getTargetPos(self.elem);
							self.sourceX = pos.x;
							self.sourceY = pos.y;
							if('ontouchstart' in document){
								self.elem.addEventListener('touchmove', move, false)
								self.elem.addEventListener('touchend', end, false)
							}else{
								self.elem.addEventListener('mousemove', move, false)
								self.elem.addEventListener('mouseup', end, false)
							}
						}
						
						//开始拖动
						function move(event){
							var currentX = event.pageX || event.touches[0].pageX;
                			var currentY = event.pageY || event.touches[0].pageY;
                			var distanceX = currentX - self.startX;
                			var distanceY = currentY - self.startY;
                			self.setTargetPos(self.elem, {
                				x: (distanceX + self.sourceX).toFixed(),
                				y: (distanceY + self.sourceY).toFixed()
                			})
						}
						
						//结束拖动
						function end(event){
							if('ontouchstart' in document){
								self.elem.removeEventListener('touchmove', move)
								self.elem.removeEventListener('touchend', end)
							}else{
								self.elem.removeEventListener('mousemove', move)
								self.elem.removeEventListener('mouseup', end)
							}
						}
					}
				}
				
				// 获取当前浏览器支持的transform兼容写法
				function getTransform() {
				    var transform = '',
				        divStyle = document.createElement('div').style,
				        // 可能涉及到的几种兼容性写法，通过循环找出浏览器识别的那一个
				        transformArr = ['transform', 'webkitTransform', 'MozTransform', 'msTransform', 'OTransform'],
				
				        i = 0,
				        len = transformArr.length;
				
				    for(; i < len; i++)  {
				        if(transformArr[i] in divStyle) {
				            // 找到之后立即返回，结束函数
				            return transform = transformArr[i];
				        }
				    }
				
				    // 如果没有找到，就直接返回空字符串
				    return transform;
				}
				function getStyle(elem, property) {
					// ie通过currentStyle来获取元素的样式，其他浏览器通过getComputedStyle来获取
					return document.defaultView.getComputedStyle ? document.defaultView.getComputedStyle(elem, false)[property] : elem.currentStyle[property];
				}
				window.Drag = Drag;
			})()
			
			var drag = new Drag('.drag');
		</script>
	</body>
</html>
