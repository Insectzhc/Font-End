define(["avalon"],function(){function t(){this.table={get:[]},this.errorFn=null,this.history=null,this.hash="",this.started=!1,this.init={}}function e(t){return!t||t===window.name||"_self"===t||"top"===t&&window==window.top?!0:!1}var r={prefix:/^(#!|#)[\/]?/,historyOpen:!0,allowReload:!0},a=!0,n=/(:id)|(\{id\})|(\{id:([A-z\d\,\[\]\{\}\-\+\*\?\!:\^\$]*)\})/g;return t.prototype={error:function(t){this.errorFn=t},config:function(t){return this.started?console.error("Router config has been set"):(this.started=!0,t.allowReload||(t.historyOpen=!0),void(this.init=avalon.mix({},r,t)))},_getRegExp:function(t,e){var r=t.replace(n,function(t,e,r,a,n){var o="([\\w.-]";return e||r?o+"+)":(/^\{[\d\,]+\}$/.test(n)||(o="("),o+n+")")});return r=r.replace(/(([^\\])([\/]+))/g,"$2\\/").replace(/(([^\\])([\.]+))/g,"$2\\.").replace(/(([^\\])([\-]+))/g,"$2\\-").replace(/(\(.*)(\\[\-]+)(.*\))/g,"$1-$3"),r="^"+r+"$",e.regexp=new RegExp(r),e},_add:function(t,e,r){this.started||this.config({});var a=this.table[t.toLowerCase()];if("/"!==e.charAt(0))return void console.error('char "/" must be in front of router rule');e=e.replace(/^[\/]+|[\/]+$|\s+/g,"");var n={};n.rule=e,n.callback=r,avalon.Array.ensure(a,this._getRegExp(e,n))},_route:function(t,e){var e=e.trim(),r=this.table[t],a=this.init;if(a.allowReload||e!==this.history){a.historyOpen&&(this.history=e,avalon.ls&&avalon.ls("lastHash",e));for(var n,o=0;n=r[o++];){var i=e.match(n.regexp);if(i)return i.shift(),n.callback.apply(n,i)}this.errorFn&&this.errorFn(e)}},on:function(t,e){this._add("get",t,e)}},avalon.bind(window,"load",function(){if(avalon.router.started){var t=avalon.router.init.prefix,e=location.hash;e=e.replace(t,"").trim(),avalon.router._route("get",e)}}),"onhashchange"in window&&window.addEventListener("hashchange",function(){if(a){var t=avalon.router.init.prefix,e=location.hash.replace(t,"").trim();avalon.router._route("get",e)}}),avalon.bind(document,"mousedown",function(t){var r="defaultPrevented"in t?t.defaultPrevented:t.returnValue===!1;if(!(r||t.ctrlKey||t.metaKey||2===t.which)){for(var n=t.target;"A"!==n.nodeName;)if(n=n.parentNode,!n||"BODY"===n.tagName)return;if(e(n.target)){if(!avalon.router.started)return;var o=n.getAttribute("href")||n.getAttribute("xlink:href"),i=avalon.router.init.prefix;if(null===o||!i.test(o))return;avalon.router.hash=o.replace(i,"").trim(),t.preventDefault(),location.hash=o,a=!1}}}),avalon.bind(document,"mouseup",function(){a||(avalon.router._route("get",avalon.router.hash),a=!0)}),avalon.router=new t});